name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      bump_build:
        description: 'Increment build number'
        default: 'true'
        type: boolean

env:
  DEVELOPER_DIR: /Applications/Xcode_16.0.app/Contents/Developer
  XCODE_VERSION: "16.0"

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Pre-Release Checks
  # ---------------------------------------------------------------------------
  pre-release:
    name: Pre-Release Checks
    runs-on: macos-15
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            tools/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('tools/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build foodshare-hooks CLI
        run: cd tools && cargo build --release --bin foodshare-hooks

      - name: Make CLI executable
        run: chmod +x tools/target/release/foodshare-hooks

      - name: Security audit
        run: tools/target/release/foodshare-hooks audit --check-deps --fail-on high

      - name: Secrets scan
        run: tools/target/release/foodshare-hooks secrets --all

      - name: Dead code report
        run: tools/target/release/foodshare-hooks analyze --dead-code || true

  # ---------------------------------------------------------------------------
  # Job 2: Archive iOS
  # ---------------------------------------------------------------------------
  archive-ios:
    name: Archive iOS
    runs-on: macos-15
    needs: pre-release
    timeout-minutes: 60
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          xcodebuild -version

      - name: Install signing certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          security import $CERTIFICATE_PATH \
            -P "$P12_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Install provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        run: |
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Setup Environment
        run: |
          mkdir -p Sources/FoodShare/Resources
          cat > Sources/FoodShare/Resources/Config.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>SUPABASE_URL</key>
              <string>${{ secrets.SUPABASE_URL }}</string>
              <key>SUPABASE_PUBLISHABLE_KEY</key>
              <string>${{ secrets.SUPABASE_ANON_KEY }}</string>
          </dict>
          </plist>
          EOF

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/org.swift.swiftpm
          key: ${{ runner.os }}-spm-release-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-release-
            ${{ runner.os }}-spm-

      - name: Resolve Xcode package dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project Darwin/FoodShare.xcodeproj \
            -scheme FoodShare \
            -clonedSourcePackagesDirPath .build

      - name: Increment build number
        if: github.event.inputs.bump_build == 'true' || github.event_name == 'push'
        run: |
          PROJECT="Darwin/FoodShare.xcodeproj"
          CURRENT_BUILD=$(xcodebuild -project "$PROJECT" -scheme FoodShare -showBuildSettings 2>/dev/null | grep CURRENT_PROJECT_VERSION | awk '{print $3}')
          NEW_BUILD=$((CURRENT_BUILD + 1))
          echo "Bumping build number from $CURRENT_BUILD to $NEW_BUILD"

          # Update via agvtool
          cd Darwin
          xcrun agvtool new-version -all $NEW_BUILD
          cd ..

      - name: Build Release archive
        run: |
          xcodebuild archive \
            -project Darwin/FoodShare.xcodeproj \
            -scheme FoodShare \
            -destination 'generic/platform=iOS' \
            -configuration Release \
            -archivePath $RUNNER_TEMP/FoodShare.xcarchive \
            -clonedSourcePackagesDirPath .build \
            COMPILER_INDEX_STORE_ENABLE=NO

      - name: Export IPA
        run: |
          # Create export options plist
          cat > $RUNNER_TEMP/ExportOptions.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          PLIST

          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/FoodShare.xcarchive \
            -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist \
            -exportPath $RUNNER_TEMP/export

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-archive
          path: ${{ runner.temp }}/FoodShare.xcarchive
          retention-days: 30

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ${{ runner.temp }}/export/*.ipa
          retention-days: 30

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

  # ---------------------------------------------------------------------------
  # Job 3: Archive Android
  # ---------------------------------------------------------------------------
  archive-android:
    name: Archive Android
    runs-on: ubuntu-latest
    needs: pre-release
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: gradle

      - name: Create local.properties
        working-directory: Android
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > local.properties
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> local.properties
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> local.properties
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> local.properties
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> local.properties
          echo "skipNativeBuild=true" >> local.properties

      - name: Configure Gradle properties
        working-directory: Android
        run: |
          echo "org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m" >> gradle.properties
          echo "org.gradle.daemon=false" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties

      - name: Make gradlew executable
        run: chmod +x Android/gradlew

      - name: Build release AAB
        working-directory: Android
        run: ./gradlew bundleRelease --no-configuration-cache --stacktrace

      - name: Sign AAB with keystore
        working-directory: Android
        run: |
          # The Gradle build with signing config handles signing.
          # Verify the AAB exists.
          AAB_PATH=$(find app/build/outputs/bundle/release -name "*.aab" | head -1)
          if [ -z "$AAB_PATH" ]; then
            echo "::error::AAB not found after build"
            exit 1
          fi
          echo "AAB built: $AAB_PATH"
          ls -lh "$AAB_PATH"

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: Android/app/build/outputs/bundle/release/*.aab
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Job 4: Upload to TestFlight (workflow_dispatch only)
  # ---------------------------------------------------------------------------
  testflight:
    name: Upload to TestFlight
    runs-on: macos-15
    needs: archive-ios
    if: github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    steps:
      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ${{ runner.temp }}/ipa

      - name: Upload to TestFlight
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
        run: |
          IPA_PATH=$(find $RUNNER_TEMP/ipa -name "*.ipa" | head -1)
          if [ -z "$IPA_PATH" ]; then
            echo "::error::No IPA file found"
            exit 1
          fi

          echo "Uploading $IPA_PATH to TestFlight..."
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --username "$APPLE_ID" \
            --password "$APP_SPECIFIC_PASSWORD"

          echo "Successfully uploaded to TestFlight"

  # ---------------------------------------------------------------------------
  # Job 5: Deploy to Play Store (workflow_dispatch only)
  # ---------------------------------------------------------------------------
  play-store:
    name: Deploy to Play Store
    runs-on: ubuntu-latest
    needs: archive-android
    if: github.event_name == 'workflow_dispatch'
    timeout-minutes: 15
    steps:
      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: ${{ runner.temp }}/aab

      - name: Deploy to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT }}
          packageName: com.flutterflow.foodshare
          releaseFiles: ${{ runner.temp }}/aab/*.aab
          track: production
          status: completed
