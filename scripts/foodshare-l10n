#!/bin/bash
#
# foodshare-l10n - Enterprise Localization CLI Tool
#
# A comprehensive CLI for managing Foodshare's localization system.
# Supports health checks, translation sync, analytics, and debugging.
#
# Usage:
#   foodshare-l10n <command> [options]
#
# Commands:
#   health      - Check backend health status
#   locales     - List supported locales
#   fetch       - Fetch translations for a locale
#   delta       - Check delta changes since version
#   stats       - Show translation statistics
#   validate    - Validate translations for completeness
#   benchmark   - Run performance benchmarks
#   monitor     - Continuous monitoring mode
#   export      - Export translations to file
#   compare     - Compare two locales
#
# Examples:
#   foodshare-l10n health
#   foodshare-l10n fetch --locale de --platform ios
#   foodshare-l10n delta --locale en --since 20260101000000
#   foodshare-l10n benchmark --iterations 10
#   foodshare-l10n monitor --interval 30
#

set -e

# Configuration
BASE_URL="${FOODSHARE_API_URL:-https://api.foodshare.club/functions/v1}"
AUTH_TOKEN="${FOODSHARE_AUTH_TOKEN:-}"
DEFAULT_LOCALE="en"
DEFAULT_PLATFORM="ios"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Helpers
log_info() { echo -e "${BLUE}i${NC} $1"; }
log_success() { echo -e "${GREEN}+${NC} $1"; }
log_warning() { echo -e "${YELLOW}!${NC} $1"; }
log_error() { echo -e "${RED}x${NC} $1"; }
log_header() { echo -e "\n${BOLD}${CYAN}$1${NC}"; }

# Get current timestamp
timestamp() { date +"%Y-%m-%d %H:%M:%S"; }

# Format bytes to human readable
format_bytes() {
    local bytes=$1
    if [ $bytes -lt 1024 ]; then
        echo "${bytes}B"
    elif [ $bytes -lt 1048576 ]; then
        echo "$((bytes / 1024))KB"
    else
        echo "$((bytes / 1048576))MB"
    fi
}

# Make API request with timing
api_request() {
    local endpoint=$1
    local method=${2:-GET}
    local start_time=$(date +%s%N)

    local curl_opts="-s"
    if [ -n "$AUTH_TOKEN" ]; then
        curl_opts="$curl_opts -H \"Authorization: Bearer $AUTH_TOKEN\""
    fi

    local response=$(curl $curl_opts "$BASE_URL$endpoint")
    local end_time=$(date +%s%N)
    local duration=$(( (end_time - start_time) / 1000000 ))

    echo "$response"
    echo "---DURATION:${duration}ms---" >&2
}

# Command: health
cmd_health() {
    log_header "Backend Health Check"
    echo ""

    # Check get-translations health
    echo -n "get-translations: "
    local health=$(curl -s "$BASE_URL/get-translations/health" 2>/dev/null)
    if echo "$health" | grep -q '"status":"ok"'; then
        local version=$(echo "$health" | sed -n 's/.*"version":"\([^"]*\)".*/\1/p')
        local delta=$(echo "$health" | grep -o '"deltaSync":true' || echo "")
        local prefetch=$(echo "$health" | grep -o '"prefetch":true' || echo "")
        log_success "OK (v$version)"
        [ -n "$delta" ] && echo "  -- Delta sync: enabled"
        [ -n "$prefetch" ] && echo "  -- Prefetch: enabled"
    else
        log_error "FAILED"
    fi

    # Check BFF health
    echo -n "bff: "
    local bff=$(curl -s "$BASE_URL/bff" 2>/dev/null)
    if echo "$bff" | grep -q '"success":true'; then
        local bff_version=$(echo "$bff" | sed -n 's/.*"version":"\([^"]*\)".*/\1/p')
        log_success "OK (v$bff_version)"
    else
        log_error "FAILED"
    fi

    # Check localization endpoint
    echo -n "localization: "
    local loc=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/localization?locale=en" 2>/dev/null)
    if [ "$loc" = "200" ]; then
        log_success "OK"
    else
        log_warning "HTTP $loc"
    fi

    echo ""
    log_info "Timestamp: $(timestamp)"
}

# Command: locales
cmd_locales() {
    log_header "Supported Locales"
    echo ""

    local response=$(curl -s "$BASE_URL/get-translations/locales")

    if echo "$response" | grep -q '"success":true'; then
        local locales=$(echo "$response" | sed -n 's/.*"locales":\[\([^]]*\)\].*/\1/p' | tr ',' '\n' | tr -d '"' | tr -d ' ')
        local count=$(echo "$locales" | wc -l | tr -d ' ')

        log_success "$count languages supported"
        echo ""

        # Display in columns
        echo "$locales" | while read locale; do
            case $locale in
                en) echo "  $locale - English (default)" ;;
                de) echo "  $locale - German (Deutsch)" ;;
                es) echo "  $locale - Spanish (Espanol)" ;;
                fr) echo "  $locale - French (Francais)" ;;
                pt) echo "  $locale - Portuguese (Portugues)" ;;
                ru) echo "  $locale - Russian" ;;
                uk) echo "  $locale - Ukrainian" ;;
                zh) echo "  $locale - Chinese" ;;
                ja) echo "  $locale - Japanese" ;;
                ko) echo "  $locale - Korean" ;;
                ar) echo "  $locale - Arabic [RTL]" ;;
                hi) echo "  $locale - Hindi" ;;
                it) echo "  $locale - Italian (Italiano)" ;;
                pl) echo "  $locale - Polish (Polski)" ;;
                nl) echo "  $locale - Dutch (Nederlands)" ;;
                cs) echo "  $locale - Czech (Cestina)" ;;
                tr) echo "  $locale - Turkish (Turkce)" ;;
                vi) echo "  $locale - Vietnamese" ;;
                id) echo "  $locale - Indonesian (Bahasa)" ;;
                th) echo "  $locale - Thai" ;;
                sv) echo "  $locale - Swedish (Svenska)" ;;
                *) echo "  $locale" ;;
            esac
        done
    else
        log_error "Failed to fetch locales"
        exit 1
    fi
}

# Command: fetch
cmd_fetch() {
    local locale=$DEFAULT_LOCALE
    local platform=$DEFAULT_PLATFORM
    local output=""
    local use_bff=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            --locale|-l) locale="$2"; shift 2 ;;
            --platform|-p) platform="$2"; shift 2 ;;
            --output|-o) output="$2"; shift 2 ;;
            --bff) use_bff=true; shift ;;
            *) shift ;;
        esac
    done

    log_header "Fetching Translations"
    echo ""
    log_info "Locale: $locale"
    log_info "Platform: $platform"
    log_info "Endpoint: $([ "$use_bff" = true ] && echo "BFF" || echo "Public")"
    echo ""

    local endpoint
    if [ "$use_bff" = true ]; then
        endpoint="/bff/translations?locale=$locale&platform=$platform"
    else
        endpoint="/get-translations?locale=$locale&platform=$platform"
    fi

    local start_time=$(date +%s%N)
    local response=$(curl -s "$BASE_URL$endpoint")
    local end_time=$(date +%s%N)
    local duration=$(( (end_time - start_time) / 1000000 ))
    local size=${#response}

    if echo "$response" | grep -q '"success":true'; then
        local version=$(echo "$response" | sed -n 's/.*"version":"\([^"]*\)".*/\1/p')
        local key_count=$(echo "$response" | grep -o '"[^"]*":' | wc -l | tr -d ' ')

        log_success "Fetched successfully"
        echo ""
        echo "  Version: $version"
        echo "  Keys: ~$key_count"
        echo "  Size: $(format_bytes $size)"
        echo "  Time: ${duration}ms"

        if [ -n "$output" ]; then
            echo "$response" > "$output"
            log_success "Saved to $output"
        fi
    else
        log_error "Failed to fetch translations"
        echo "$response" | head -c 200
        exit 1
    fi
}

# Command: delta
cmd_delta() {
    local locale=$DEFAULT_LOCALE
    local since=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --locale|-l) locale="$2"; shift 2 ;;
            --since|-s) since="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    if [ -z "$since" ]; then
        log_error "Missing --since parameter"
        echo "Usage: foodshare-l10n delta --locale en --since 20260101000000"
        exit 1
    fi

    log_header "Delta Sync Check"
    echo ""
    log_info "Locale: $locale"
    log_info "Since version: $since"
    echo ""

    local response=$(curl -s "$BASE_URL/get-translations/delta?locale=$locale&since=$since")

    if echo "$response" | grep -q '"success":true'; then
        local has_changes=$(echo "$response" | grep -o '"hasChanges":true' || echo "")
        local current=$(echo "$response" | sed -n 's/.*"currentVersion":"\([^"]*\)".*/\1/p')

        if [ -n "$has_changes" ]; then
            local added=$(echo "$response" | sed -n 's/.*"added":\([0-9]*\).*/\1/p')
            local updated=$(echo "$response" | sed -n 's/.*"updated":\([0-9]*\).*/\1/p')
            local deleted=$(echo "$response" | sed -n 's/.*"deleted":\([0-9]*\).*/\1/p')

            log_success "Changes detected"
            echo ""
            echo "  Current version: $current"
            echo "  Added: ${added:-0} keys"
            echo "  Updated: ${updated:-0} keys"
            echo "  Deleted: ${deleted:-0} keys"
        else
            log_info "No changes since $since"
            echo "  Current version: $current"
        fi
    else
        log_error "Delta sync failed"
        exit 1
    fi
}

# Command: stats
cmd_stats() {
    log_header "Translation Statistics"
    echo ""

    # Fetch English as baseline
    local en_response=$(curl -s "$BASE_URL/get-translations?locale=en")
    local en_keys=$(echo "$en_response" | grep -o '"[^"]*":"[^"]*"' | wc -l | tr -d ' ')
    local en_size=${#en_response}
    local en_version=$(echo "$en_response" | sed -n 's/.*"version":"\([^"]*\)".*/\1/p')

    echo "Base Language (English)"
    echo "  Version: $en_version"
    echo "  Keys: ~$en_keys"
    echo "  Size: $(format_bytes $en_size)"
    echo ""

    # Get all locales
    local locales=$(curl -s "$BASE_URL/get-translations/locales" | sed -n 's/.*"locales":\[\([^]]*\)\].*/\1/p' | tr ',' '\n' | tr -d '"' | tr -d ' ')
    local total_size=0
    local locale_count=0

    echo "All Locales:"
    for locale in $locales; do
        local response=$(curl -s "$BASE_URL/get-translations?locale=$locale")
        local size=${#response}
        total_size=$((total_size + size))
        locale_count=$((locale_count + 1))
        printf "  %-4s %s\n" "$locale" "$(format_bytes $size)"
    done

    echo ""
    echo "Summary:"
    echo "  Total locales: $locale_count"
    echo "  Total size: $(format_bytes $total_size)"
    echo "  Avg per locale: $(format_bytes $((total_size / locale_count)))"
}

# Command: validate
cmd_validate() {
    local locale=${1:-$DEFAULT_LOCALE}

    log_header "Validating Translations: $locale"
    echo ""

    # Fetch English keys as reference
    local en_response=$(curl -s "$BASE_URL/get-translations?locale=en")
    local target_response=$(curl -s "$BASE_URL/get-translations?locale=$locale")

    if ! echo "$en_response" | grep -q '"success":true'; then
        log_error "Failed to fetch English translations"
        exit 1
    fi

    if ! echo "$target_response" | grep -q '"success":true'; then
        log_error "Failed to fetch $locale translations"
        exit 1
    fi

    # Simple key count comparison
    local en_keys=$(echo "$en_response" | grep -o '"[^"]*":"' | wc -l | tr -d ' ')
    local target_keys=$(echo "$target_response" | grep -o '"[^"]*":"' | wc -l | tr -d ' ')

    local coverage=$((target_keys * 100 / en_keys))

    echo "Reference (en): ~$en_keys keys"
    echo "Target ($locale): ~$target_keys keys"
    echo ""

    if [ $coverage -ge 95 ]; then
        log_success "Coverage: ${coverage}% (Excellent)"
    elif [ $coverage -ge 80 ]; then
        log_warning "Coverage: ${coverage}% (Good)"
    else
        log_error "Coverage: ${coverage}% (Needs work)"
    fi
}

# Command: benchmark
cmd_benchmark() {
    local iterations=5
    local locale=$DEFAULT_LOCALE

    while [[ $# -gt 0 ]]; do
        case $1 in
            --iterations|-n) iterations="$2"; shift 2 ;;
            --locale|-l) locale="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    log_header "Performance Benchmark"
    echo ""
    log_info "Locale: $locale"
    log_info "Iterations: $iterations"
    echo ""

    local total_time=0
    local min_time=999999
    local max_time=0
    local total_size=0

    echo "Running benchmarks..."
    for i in $(seq 1 $iterations); do
        local start_time=$(date +%s%N)
        local response=$(curl -s "$BASE_URL/get-translations?locale=$locale")
        local end_time=$(date +%s%N)
        local duration=$(( (end_time - start_time) / 1000000 ))
        local size=${#response}

        total_time=$((total_time + duration))
        total_size=$((total_size + size))
        [ $duration -lt $min_time ] && min_time=$duration
        [ $duration -gt $max_time ] && max_time=$duration

        printf "  Run %d: %dms (%s)\n" $i $duration "$(format_bytes $size)"
    done

    local avg_time=$((total_time / iterations))
    local avg_size=$((total_size / iterations))

    echo ""
    echo "Results:"
    echo "  Min: ${min_time}ms"
    echo "  Max: ${max_time}ms"
    echo "  Avg: ${avg_time}ms"
    echo "  Avg size: $(format_bytes $avg_size)"
    echo ""

    if [ $avg_time -lt 200 ]; then
        log_success "Performance: Excellent (<200ms)"
    elif [ $avg_time -lt 500 ]; then
        log_success "Performance: Good (<500ms)"
    elif [ $avg_time -lt 1000 ]; then
        log_warning "Performance: Acceptable (<1s)"
    else
        log_error "Performance: Slow (>1s)"
    fi
}

# Command: monitor
cmd_monitor() {
    local interval=30

    while [[ $# -gt 0 ]]; do
        case $1 in
            --interval|-i) interval="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    log_header "Continuous Monitoring"
    echo ""
    log_info "Interval: ${interval}s"
    log_info "Press Ctrl+C to stop"
    echo ""

    while true; do
        local timestamp=$(date +"%H:%M:%S")

        # Health check
        local health=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/get-translations/health" 2>/dev/null)
        local health_status="OK"
        [ "$health" != "200" ] && health_status="FAIL"

        # Response time
        local start_time=$(date +%s%N)
        curl -s "$BASE_URL/get-translations?locale=en" > /dev/null
        local end_time=$(date +%s%N)
        local duration=$(( (end_time - start_time) / 1000000 ))

        # BFF check
        local bff=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/bff/translations?locale=en" 2>/dev/null)
        local bff_status="OK"
        [ "$bff" != "200" ] && [ "$bff" != "401" ] && bff_status="FAIL"

        printf "[%s] Health: %-4s | BFF: %-4s | Latency: %dms\n" "$timestamp" "$health_status" "$bff_status" "$duration"

        sleep $interval
    done
}

# Command: export
cmd_export() {
    local locale=$DEFAULT_LOCALE
    local format="json"
    local output=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --locale|-l) locale="$2"; shift 2 ;;
            --format|-f) format="$2"; shift 2 ;;
            --output|-o) output="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    [ -z "$output" ] && output="translations_${locale}.${format}"

    log_header "Exporting Translations"
    echo ""
    log_info "Locale: $locale"
    log_info "Format: $format"
    log_info "Output: $output"
    echo ""

    local response=$(curl -s "$BASE_URL/get-translations?locale=$locale")

    if echo "$response" | grep -q '"success":true'; then
        case $format in
            json)
                echo "$response" | python3 -c "import sys,json; d=json.load(sys.stdin); print(json.dumps(d.get('data',{}).get('messages',{}), indent=2, ensure_ascii=False))" > "$output"
                ;;
            flat)
                echo "$response" | python3 -c "
import sys,json
def flatten(d, prefix=''):
    items = []
    for k, v in d.items():
        key = f'{prefix}.{k}' if prefix else k
        if isinstance(v, dict):
            items.extend(flatten(v, key))
        else:
            items.append(f'{key}={v}')
    return items
d = json.load(sys.stdin).get('data',{}).get('messages',{})
print('\n'.join(flatten(d)))
" > "$output"
                ;;
            *)
                log_error "Unknown format: $format"
                exit 1
                ;;
        esac

        local size=$(wc -c < "$output" | tr -d ' ')
        log_success "Exported $(format_bytes $size) to $output"
    else
        log_error "Failed to fetch translations"
        exit 1
    fi
}

# Command: compare
cmd_compare() {
    local locale1="en"
    local locale2=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --from) locale1="$2"; shift 2 ;;
            --to) locale2="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    if [ -z "$locale2" ]; then
        log_error "Missing --to parameter"
        echo "Usage: foodshare-l10n compare --from en --to de"
        exit 1
    fi

    log_header "Comparing Locales"
    echo ""
    log_info "From: $locale1"
    log_info "To: $locale2"
    echo ""

    local resp1=$(curl -s "$BASE_URL/get-translations?locale=$locale1")
    local resp2=$(curl -s "$BASE_URL/get-translations?locale=$locale2")

    local keys1=$(echo "$resp1" | grep -o '"[^"]*":"' | wc -l | tr -d ' ')
    local keys2=$(echo "$resp2" | grep -o '"[^"]*":"' | wc -l | tr -d ' ')
    local size1=${#resp1}
    local size2=${#resp2}

    echo "$locale1:"
    echo "  Keys: ~$keys1"
    echo "  Size: $(format_bytes $size1)"
    echo ""
    echo "$locale2:"
    echo "  Keys: ~$keys2"
    echo "  Size: $(format_bytes $size2)"
    echo ""

    local diff=$((keys1 - keys2))
    if [ $diff -gt 0 ]; then
        log_warning "$locale2 is missing ~$diff keys compared to $locale1"
    elif [ $diff -lt 0 ]; then
        log_info "$locale2 has ~$((-diff)) more keys than $locale1"
    else
        log_success "Both locales have similar key counts"
    fi
}

# Help
show_help() {
    echo "foodshare-l10n - Enterprise Localization CLI Tool"
    echo ""
    echo "Usage: foodshare-l10n <command> [options]"
    echo ""
    echo "Commands:"
    echo "  health              Check backend health status"
    echo "  locales             List supported locales"
    echo "  fetch               Fetch translations for a locale"
    echo "  delta               Check delta changes since version"
    echo "  stats               Show translation statistics"
    echo "  validate            Validate translations for completeness"
    echo "  benchmark           Run performance benchmarks"
    echo "  monitor             Continuous monitoring mode"
    echo "  export              Export translations to file"
    echo "  compare             Compare two locales"
    echo ""
    echo "Options:"
    echo "  --locale, -l        Locale code (default: en)"
    echo "  --platform, -p      Platform (default: ios)"
    echo "  --output, -o        Output file path"
    echo "  --since, -s         Version for delta sync"
    echo "  --iterations, -n    Number of benchmark iterations"
    echo "  --interval, -i      Monitoring interval in seconds"
    echo "  --bff               Use BFF endpoint (requires auth)"
    echo ""
    echo "Environment:"
    echo "  FOODSHARE_API_URL   Base API URL"
    echo "  FOODSHARE_AUTH_TOKEN Bearer token for BFF endpoints"
    echo ""
    echo "Examples:"
    echo "  foodshare-l10n health"
    echo "  foodshare-l10n fetch --locale de --platform ios"
    echo "  foodshare-l10n delta --locale en --since 20260101000000"
    echo "  foodshare-l10n benchmark --iterations 10"
    echo "  foodshare-l10n monitor --interval 30"
    echo "  foodshare-l10n export --locale de --format json --output de.json"
    echo "  foodshare-l10n compare --from en --to de"
}

# Main
main() {
    local command=${1:-help}
    shift || true

    case $command in
        health) cmd_health "$@" ;;
        locales) cmd_locales "$@" ;;
        fetch) cmd_fetch "$@" ;;
        delta) cmd_delta "$@" ;;
        stats) cmd_stats "$@" ;;
        validate) cmd_validate "$@" ;;
        benchmark) cmd_benchmark "$@" ;;
        monitor) cmd_monitor "$@" ;;
        export) cmd_export "$@" ;;
        compare) cmd_compare "$@" ;;
        help|--help|-h) show_help ;;
        *)
            log_error "Unknown command: $command"
            echo "Run 'foodshare-l10n help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
